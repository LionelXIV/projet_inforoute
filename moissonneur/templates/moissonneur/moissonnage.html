{% extends 'base.html' %}

{% block title %}Moissonnage - DataQC{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1>üîÑ Moissonnage des donn√©es</h1>
        <p class="lead">R√©cup√©ration automatique des m√©tadonn√©es depuis Donn√©es Qu√©bec</p>
    </div>
</div>

<!-- Statistiques actuelles -->
<div class="row mt-4">
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">üè¢ Organisations</h5>
                <h2 class="text-primary">{{ nombre_organisations }}</h2>
                <p class="card-text">Organisations moissonn√©es</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">üìä Jeux de donn√©es</h5>
                <h2 class="text-success">{{ nombre_jeux_donnees }}</h2>
                <p class="card-text">Jeux de donn√©es disponibles</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card text-center">
            <div class="card-body">
                <h5 class="card-title">üìÅ Ressources</h5>
                <h2 class="text-info">{{ nombre_ressources }}</h2>
                <p class="card-text">Fichiers de donn√©es</p>
            </div>
        </div>
    </div>
</div>

<!-- Actions de moissonnage -->
<div class="row mt-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Actions de moissonnage</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Moissonnage complet</h6>
                        <p class="text-muted">R√©cup√®re toutes les organisations et jeux de donn√©es depuis Donn√©es Qu√©bec</p>
                        <button type="button" class="btn btn-primary btn-lg" id="btn-moissonnage-complet" onclick="demarrerMoissonnageComplet()">
                            D√©marrer le moissonnage
                        </button>
                        <button type="button" class="btn btn-danger btn-lg" id="btn-arreter-moissonnage" onclick="arreterMoissonnage()" style="display: none;">
                            Arr√™ter le moissonnage
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h6>Test rapide</h6>
                        <p class="text-muted">R√©cup√®re seulement les 10 premi√®res organisations pour tester</p>
                        <button type="button" class="btn btn-outline-primary btn-lg" onclick="testMoissonnage()">
                            Test rapide
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Zone de progression -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card" id="progression-card" style="display: none;">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Progression du moissonnage</h5>
                <button type="button" class="btn btn-sm btn-outline-danger" id="btn-arreter-progression" onclick="arreterMoissonnage()" style="display: none;">
                    Arr√™ter
                </button>
            </div>
            <div class="card-body">
                <div class="progress mb-3" style="height: 30px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" 
                         style="width: 0%" 
                         id="progress-bar">
                        <span id="progress-percent">0%</span>
                    </div>
                </div>
                <div id="progression-text" class="mt-2">Initialisation...</div>
                <div id="progression-details" class="text-muted small mt-2"></div>
            </div>
        </div>
    </div>
</div>

<!-- Formulaire cach√© pour CSRF token -->
<form style="display: none;" id="csrf-form">
    {% csrf_token %}
</form>

<!-- Messages -->
{% if messages %}
<div class="row mt-4">
    <div class="col-12">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Informations sur la source -->
<div class="row mt-5">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Source de donn√©es</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h6>Donn√©es Qu√©bec</h6>
                        <p class="text-muted">
                            Le portail de donn√©es ouvertes du gouvernement du Qu√©bec. 
                            Cette plateforme moissonne automatiquement les m√©tadonn√©es 
                            des organisations et jeux de donn√©es disponibles.
                        </p>
                        <ul class="list-unstyled">
                            <li><strong>URL:</strong> <a href="https://www.donneesquebec.ca" target="_blank">https://www.donneesquebec.ca</a></li>
                            <li><strong>API:</strong> CKAN 3.0</li>
                            <li><strong>Derni√®re mise √† jour:</strong> Automatique</li>
                        </ul>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="badge bg-success fs-6 p-3">
                            ‚úì<br>
                            Source active
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let moissonnageEnCours = false;
let moissonnageArrete = false;

function demarrerMoissonnageComplet() {
    if (moissonnageEnCours) {
        return;
    }
    
    moissonnageEnCours = true;
    
    const progressionCard = document.getElementById('progression-card');
    const progressBar = document.getElementById('progress-bar');
    const progressPercent = document.getElementById('progress-percent');
    const progressionText = document.getElementById('progression-text');
    const progressionDetails = document.getElementById('progression-details');
    const btnMoissonnage = document.getElementById('btn-moissonnage-complet');
    const btnArreter = document.getElementById('btn-arreter-moissonnage');
    const btnArreterProgression = document.getElementById('btn-arreter-progression');
    
    // Afficher la zone de progression
    progressionCard.style.display = 'block';
    btnMoissonnage.disabled = true;
    btnArreter.style.display = 'inline-block';
    btnArreterProgression.style.display = 'inline-block';
    
    // D√©marrer le moissonnage
    fetch('{% url "moissonnage_complet_ajax" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // D√©marrer le polling pour mettre √† jour la progression
            demarrerPolling();
        } else {
            progressionText.textContent = '‚ùå Erreur: ' + data.message;
            btnMoissonnage.disabled = false;
            btnArreter.style.display = 'none';
            btnArreterProgression.style.display = 'none';
            moissonnageEnCours = false;
        }
    })
    .catch(error => {
        progressionText.textContent = '‚ùå Erreur: ' + error.message;
        btnMoissonnage.disabled = false;
        btnArreter.style.display = 'none';
        btnArreterProgression.style.display = 'none';
        moissonnageEnCours = false;
    });
}

let pollingInterval = null;

function demarrerPolling() {
    const progressBar = document.getElementById('progress-bar');
    const progressPercent = document.getElementById('progress-percent');
    const progressionText = document.getElementById('progression-text');
    const progressionDetails = document.getElementById('progression-details');
    const btnMoissonnage = document.getElementById('btn-moissonnage-complet');
    const btnArreter = document.getElementById('btn-arreter-moissonnage');
    const btnArreterProgression = document.getElementById('btn-arreter-progression');
    
    // Polling toutes les secondes
    pollingInterval = setInterval(() => {
        fetch('{% url "moissonnage_statut" %}', {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            // Mettre √† jour la barre de progression
            progressBar.style.width = data.progression + '%';
            progressPercent.textContent = data.progression + '%';
            progressionText.textContent = data.message;
            progressionDetails.textContent = `Organisations: ${data.organisations || 0} | Jeux: ${data.jeux || 0} | Ressources: ${data.ressources || 0}`;
            
            // Si termin√©
            if (!data.en_cours) {
                clearInterval(pollingInterval);
                progressBar.classList.remove('progress-bar-animated');
                btnMoissonnage.disabled = false;
                btnArreter.style.display = 'none';
                btnArreterProgression.style.display = 'none';
                moissonnageEnCours = false;
                
                // Recharger la page apr√®s 3 secondes
                setTimeout(() => {
                    location.reload();
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Erreur polling:', error);
        });
    }, 1000); // Toutes les secondes
}

function arreterMoissonnage() {
    if (!moissonnageEnCours) {
        return;
    }
    
    // Arr√™ter le polling
    if (pollingInterval) {
        clearInterval(pollingInterval);
    }
    
    // Demander l'arr√™t au serveur
    fetch('{% url "moissonnage_arreter" %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        // R√©initialiser l'interface
        const progressionCard = document.getElementById('progression-card');
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const progressionText = document.getElementById('progression-text');
        const progressionDetails = document.getElementById('progression-details');
        const btnMoissonnage = document.getElementById('btn-moissonnage-complet');
        const btnArreter = document.getElementById('btn-arreter-moissonnage');
        const btnArreterProgression = document.getElementById('btn-arreter-progression');
        
        progressBar.style.width = '0%';
        progressPercent.textContent = '0%';
        progressionText.textContent = '‚èπÔ∏è Moissonnage arr√™t√©';
        progressionDetails.textContent = 'Organisations: 0 | Jeux: 0 | Ressources: 0';
        progressBar.classList.remove('progress-bar-animated');
        
        btnMoissonnage.disabled = false;
        btnArreter.style.display = 'none';
        btnArreterProgression.style.display = 'none';
        moissonnageEnCours = false;
        
        // Recharger la page pour mettre √† jour les statistiques
        setTimeout(() => {
            location.reload();
        }, 500);
    });
}

function testMoissonnage() {
    const progressionCard = document.getElementById('progression-card');
    const progressBar = document.getElementById('progress-bar');
    const progressPercent = document.getElementById('progress-percent');
    const progressionText = document.getElementById('progression-text');
    
    // Afficher la zone de progression
    progressionCard.style.display = 'block';
    
    // Simuler la progression
    let progress = 0;
    const interval = setInterval(() => {
        progress += 10;
        progressBar.style.width = progress + '%';
        progressPercent.textContent = progress + '%';
        
        if (progress <= 30) {
            progressionText.textContent = 'R√©cup√©ration des organisations...';
        } else if (progress <= 60) {
            progressionText.textContent = 'Sauvegarde en base de donn√©es...';
        } else if (progress <= 90) {
            progressionText.textContent = 'Finalisation...';
        } else {
            progressionText.textContent = 'Termin√© !';
            clearInterval(interval);
            
            // Faire l'appel AJAX r√©el
            fetch('{% url "moissonnage_ajax" %}', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    progressionText.textContent = data.message;
                    // Recharger la page apr√®s 2 secondes
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                } else {
                    progressionText.textContent = 'Erreur: ' + data.message;
                }
            })
            .catch(error => {
                progressionText.textContent = 'Erreur: ' + error.message;
            });
        }
    }, 200);
}

// Fonction helper pour r√©cup√©rer le cookie CSRF
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    // Si pas trouv√© dans les cookies, chercher dans le formulaire
    if (!cookieValue) {
        const csrfInput = document.querySelector('[name=csrfmiddlewaretoken]');
        if (csrfInput) {
            cookieValue = csrfInput.value;
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
